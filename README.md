# Skybolt Go

Go adapter for [Skybolt](https://github.com/JensRoland/skybolt) - High-performance asset caching for multi-page applications.

## Installation

```bash
go get github.com/JensRoland/skybolt-go
```

## Prerequisites

1. Install and configure the Vite plugin: `npm install @skybolt/vite-plugin`
2. Build your project: `npm run build`
3. Ensure `render-map.json` is generated in your build output

## Usage

```go
package main

import (
    "net/http"

    skybolt "github.com/JensRoland/skybolt-go"
)

func handler(w http.ResponseWriter, r *http.Request) {
    // Get cookies from request
    cookies := make(map[string]string)
    for _, c := range r.Cookies() {
        cookies[c.Name] = c.Value
    }

    // Initialize Skybolt
    sb, err := skybolt.New("static/.skybolt/render-map.json", cookies, "")
    if err != nil {
        http.Error(w, err.Error(), http.StatusInternalServerError)
        return
    }

    // Use in your template
    fmt.Fprintf(w, `<!DOCTYPE html>
<html>
<head>
    %s
    %s
    %s
</head>
<body>
    <h1>Hello Skybolt!</h1>
    %s
</body>
</html>`,
        sb.CSS("src/css/critical.css", false),
        sb.LaunchScript(),
        sb.CSS("src/css/main.css", true),
        sb.Script("src/js/app.js", true),
    )
}
```

## API

### `New(renderMapPath string, cookies map[string]string, cdnURL string) (*Skybolt, error)`

Create a new Skybolt instance.

- `renderMapPath` - Path to `render-map.json` generated by Vite plugin
- `cookies` - Cookie map (can be `nil`)
- `cdnURL` - Optional CDN URL prefix (can be empty string `""`)

```go
// Basic usage
sb, err := skybolt.New("static/.skybolt/render-map.json", cookies, "")

// With CDN
sb, err := skybolt.New(
    "static/.skybolt/render-map.json",
    cookies,
    "https://cdn.example.com",
)
```

### `CSS(entry string, async bool) string`

Render CSS asset.

- First visit: Inlines CSS with caching attributes
- Repeat visit: Outputs `<link>` tag (Service Worker serves from cache)

When `async` is `true`, CSS loads non-blocking:

- First visit: Uses `media="print"` trick, swaps to `all` on load
- Repeat visit: Uses `<link rel="preload">` with `onload`

```go
// Blocking - for critical CSS
sb.CSS("src/css/critical.css", false)

// Non-blocking - for non-critical CSS
sb.CSS("src/css/main.css", true)
```

### `Script(entry string, module bool) string`

Render JavaScript asset.

- First visit: Inlines JS with caching attributes
- Repeat visit: Outputs `<script>` tag (Service Worker serves from cache)

```go
// ES module
sb.Script("src/js/app.js", true)

// Classic script
sb.Script("src/js/legacy.js", false)
```

### `LaunchScript() string`

Render the Skybolt client launcher. Call once in `<head>` before other assets.

```go
sb.LaunchScript()
```

### `GetAssetURL(entry string) string`

Get the URL for an asset (for manual use cases).

```go
url := sb.GetAssetURL("src/css/main.css")
// "/assets/main-Pw3rT8vL.css"
```

### `GetAssetHash(entry string) string`

Get the content hash for an asset.

```go
hash := sb.GetAssetHash("src/css/main.css")
// "Pw3rT8vL"
```

### `Preload(entry, asType, mimeType, crossorigin, fetchpriority string) string`

Render preload link for critical resources like fonts and images.

```go
// Preload hero image with high priority
sb.Preload("images/hero.jpg", "image", "", "", "high")

// Preload font
sb.Preload("fonts/inter.woff2", "font", "font/woff2", "anonymous", "")

// Preload a Vite-built asset (resolved from render-map)
sb.Preload("src/css/main.css", "style", "", "", "")
```

Parameters:

- `entry` - Source file path or direct URL
- `asType` - Resource type (`"image"`, `"font"`, `"style"`, `"script"`, `"fetch"`)
- `mimeType` - MIME type (e.g., `"font/woff2"`, `"image/webp"`) or empty string
- `crossorigin` - Crossorigin attribute (`"anonymous"`, `"use-credentials"`) or empty string
- `fetchpriority` - Fetch priority (`"high"`, `"low"`, `"auto"`) or empty string

## Service Worker Setup

The Service Worker must be served from your domain root. Configure your web server or add a handler:

**Go handler:**

```go
http.HandleFunc("/skybolt-sw.js", func(w http.ResponseWriter, r *http.Request) {
    w.Header().Set("Content-Type", "application/javascript")
    w.Header().Set("Service-Worker-Allowed", "/")
    http.ServeFile(w, r, "static/dist/skybolt-sw.js")
})
```

**Nginx:**

```nginx
location = /skybolt-sw.js {
    alias /path/to/static/dist/skybolt-sw.js;
}
```

## Framework Integration

### Gin

```go
package main

import (
    "github.com/gin-gonic/gin"
    skybolt "github.com/JensRoland/skybolt-go"
)

func main() {
    r := gin.Default()
    r.LoadHTMLGlob("templates/*")

    // Serve the Service Worker
    r.StaticFile("/skybolt-sw.js", "static/dist/skybolt-sw.js")

    r.GET("/", func(c *gin.Context) {
        cookies := make(map[string]string)
        for _, cookie := range c.Request.Cookies() {
            cookies[cookie.Name] = cookie.Value
        }

        sb, _ := skybolt.New("static/.skybolt/render-map.json", cookies, "")

        c.HTML(200, "index.html", gin.H{
            "criticalCSS":  sb.CSS("src/css/critical.css", false),
            "launchScript": sb.LaunchScript(),
            "mainCSS":      sb.CSS("src/css/main.css", true),
            "appScript":    sb.Script("src/js/app.js", true),
        })
    })

    r.Run(":8080")
}
```

```html
<!-- templates/index.html -->
<!DOCTYPE html>
<html>
<head>
    {{ .criticalCSS }}
    {{ .launchScript }}
    {{ .mainCSS }}
</head>
<body>
    <h1>Hello Skybolt!</h1>
    {{ .appScript }}
</body>
</html>
```

### Echo

```go
package main

import (
    "html/template"
    "io"

    "github.com/labstack/echo/v4"
    skybolt "github.com/JensRoland/skybolt-go"
)

type Template struct {
    templates *template.Template
}

func (t *Template) Render(w io.Writer, name string, data interface{}, c echo.Context) error {
    return t.templates.ExecuteTemplate(w, name, data)
}

func main() {
    e := echo.New()

    t := &Template{
        templates: template.Must(template.ParseGlob("templates/*.html")),
    }
    e.Renderer = t

    // Serve the Service Worker
    e.File("/skybolt-sw.js", "static/dist/skybolt-sw.js")

    e.GET("/", func(c echo.Context) error {
        cookies := make(map[string]string)
        for _, cookie := range c.Cookies() {
            cookies[cookie.Name] = cookie.Value
        }

        sb, _ := skybolt.New("static/.skybolt/render-map.json", cookies, "")

        return c.Render(200, "index.html", map[string]interface{}{
            "criticalCSS":  template.HTML(sb.CSS("src/css/critical.css", false)),
            "launchScript": template.HTML(sb.LaunchScript()),
            "mainCSS":      template.HTML(sb.CSS("src/css/main.css", true)),
            "appScript":    template.HTML(sb.Script("src/js/app.js", true)),
        })
    })

    e.Start(":8080")
}
```

### Fiber

```go
package main

import (
    "github.com/gofiber/fiber/v2"
    "github.com/gofiber/template/html/v2"
    skybolt "github.com/JensRoland/skybolt-go"
)

func main() {
    engine := html.New("./templates", ".html")
    app := fiber.New(fiber.Config{
        Views: engine,
    })

    // Serve the Service Worker
    app.Static("/skybolt-sw.js", "static/dist/skybolt-sw.js")

    app.Get("/", func(c *fiber.Ctx) error {
        cookies := make(map[string]string)
        c.Request().Header.VisitAllCookie(func(key, value []byte) {
            cookies[string(key)] = string(value)
        })

        sb, _ := skybolt.New("static/.skybolt/render-map.json", cookies, "")

        return c.Render("index", fiber.Map{
            "criticalCSS":  sb.CSS("src/css/critical.css", false),
            "launchScript": sb.LaunchScript(),
            "mainCSS":      sb.CSS("src/css/main.css", true),
            "appScript":    sb.Script("src/js/app.js", true),
        })
    })

    app.Listen(":8080")
}
```

## Requirements

- Go 1.19+
- Vite with `@skybolt/vite-plugin`

## License

MIT
